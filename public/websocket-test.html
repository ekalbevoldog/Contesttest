<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Connection Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: #111;
      color: #eee;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      color: #FFBF0D;
      margin-bottom: 30px;
    }
    .card {
      background-color: #222;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #333;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
    .status {
      padding: 10px 15px;
      border-radius: 4px;
      font-weight: bold;
      display: inline-block;
      margin-bottom: 10px;
    }
    .connected {
      background-color: #285739;
      color: #83f8bc;
    }
    .disconnected {
      background-color: #6b1a1a;
      color: #ff9f9f;
    }
    .connecting {
      background-color: #5c4c10;
      color: #ffe07d;
    }
    #messageLog {
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      background-color: #333;
      border-radius: 4px;
      margin-top: 10px;
      border: 1px solid #444;
      font-family: monospace;
    }
    .log-item {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #444;
    }
    .log-received {
      color: #83f8bc;
    }
    .log-sent {
      color: #ffe07d;
    }
    .log-error {
      color: #ff9f9f;
    }
    .log-system {
      color: #9f9fff;
    }
    button {
      background-color: #FFBF0D;
      color: #000;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background-color: #ffcc33;
    }
    .controls {
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <h1>WebSocket Connection Test</h1>
  
  <div class="card">
    <h2>Connection Status</h2>
    <div id="connectionStatus" class="status disconnected">Disconnected</div>
    <div class="controls">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" disabled>Disconnect</button>
    </div>
  </div>
  
  <div class="card">
    <h2>Test Messages</h2>
    <div class="controls">
      <button id="pingBtn" disabled>Send Ping</button>
      <button id="globalMsgBtn" disabled>Send Global Message</button>
      <button id="subscribeBtn" disabled>Subscribe to Channel</button>
    </div>
  </div>
  
  <div class="card">
    <h2>Message Log</h2>
    <div id="messageLog"></div>
  </div>

  <script>
    // DOM Elements
    const statusElement = document.getElementById('connectionStatus');
    const messageLog = document.getElementById('messageLog');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const pingBtn = document.getElementById('pingBtn');
    const globalMsgBtn = document.getElementById('globalMsgBtn');
    const subscribeBtn = document.getElementById('subscribeBtn');
    
    // WebSocket instance
    let socket = null;
    
    // Log function
    function log(message, type = 'system') {
      const logItem = document.createElement('div');
      logItem.className = `log-item log-${type}`;
      logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      messageLog.appendChild(logItem);
      messageLog.scrollTop = messageLog.scrollHeight;
    }
    
    // Connect to WebSocket server
    function connect() {
      try {
        // Get host from current URL
        const host = window.location.host;
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${host}/ws`;
        
        log(`Connecting to ${wsUrl}...`);
        statusElement.textContent = 'Connecting...';
        statusElement.className = 'status connecting';
        
        socket = new WebSocket(wsUrl);
        
        // Connection opened
        socket.addEventListener('open', (event) => {
          log('Connection established successfully', 'system');
          statusElement.textContent = 'Connected';
          statusElement.className = 'status connected';
          
          // Enable/disable buttons
          connectBtn.disabled = true;
          disconnectBtn.disabled = false;
          pingBtn.disabled = false;
          globalMsgBtn.disabled = false;
          subscribeBtn.disabled = false;
        });
        
        // Listen for messages
        socket.addEventListener('message', (event) => {
          try {
            const data = JSON.parse(event.data);
            log(`Received: ${JSON.stringify(data, null, 2)}`, 'received');
          } catch (error) {
            log(`Received raw message: ${event.data}`, 'received');
          }
        });
        
        // Connection closed
        socket.addEventListener('close', (event) => {
          log(`Connection closed: ${event.code} ${event.reason}`, 'system');
          statusElement.textContent = 'Disconnected';
          statusElement.className = 'status disconnected';
          
          // Reset button states
          connectBtn.disabled = false;
          disconnectBtn.disabled = true;
          pingBtn.disabled = true;
          globalMsgBtn.disabled = true;
          subscribeBtn.disabled = true;
        });
        
        // Connection error
        socket.addEventListener('error', (error) => {
          log(`WebSocket error: ${error}`, 'error');
          statusElement.textContent = 'Error';
          statusElement.className = 'status disconnected';
        });
      } catch (error) {
        log(`Error creating WebSocket: ${error}`, 'error');
      }
    }
    
    // Disconnect from WebSocket server
    function disconnect() {
      if (socket) {
        log('Disconnecting...', 'system');
        socket.close();
      }
    }
    
    // Send a ping message
    function sendPing() {
      if (socket && socket.readyState === WebSocket.OPEN) {
        const message = { type: 'ping' };
        socket.send(JSON.stringify(message));
        log(`Sent: ${JSON.stringify(message)}`, 'sent');
      } else {
        log('Cannot send ping - WebSocket not connected', 'error');
      }
    }
    
    // Send a global message
    function sendGlobalMessage() {
      if (socket && socket.readyState === WebSocket.OPEN) {
        const message = {
          type: 'message',
          channel: 'global',
          content: 'Test message from browser client',
          persist: false
        };
        socket.send(JSON.stringify(message));
        log(`Sent: ${JSON.stringify(message)}`, 'sent');
      } else {
        log('Cannot send message - WebSocket not connected', 'error');
      }
    }
    
    // Subscribe to a channel
    function subscribeToChannel() {
      if (socket && socket.readyState === WebSocket.OPEN) {
        const channel = 'test-channel';
        const message = {
          type: 'subscribe',
          channel
        };
        socket.send(JSON.stringify(message));
        log(`Sent: ${JSON.stringify(message)}`, 'sent');
      } else {
        log('Cannot subscribe - WebSocket not connected', 'error');
      }
    }
    
    // Add event listeners to buttons
    connectBtn.addEventListener('click', connect);
    disconnectBtn.addEventListener('click', disconnect);
    pingBtn.addEventListener('click', sendPing);
    globalMsgBtn.addEventListener('click', sendGlobalMessage);
    subscribeBtn.addEventListener('click', subscribeToChannel);
    
    // Initial connection status
    log('Page loaded. Click "Connect" to establish WebSocket connection.');
  </script>
</body>
</html>